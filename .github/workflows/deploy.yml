name: Deploy to Production

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches:
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: marga-ghale/ora_scrum_backend

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file on server
        uses: appleboy/ssh-action@v1.0.3
        env:
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USER: ${{ secrets.SMTP_USER }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SMTP_FROM: ${{ secrets.SMTP_FROM }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          envs: JWT_SECRET,SMTP_HOST,SMTP_PORT,SMTP_USER,SMTP_PASSWORD,SMTP_FROM
          script: |
            cd /root/ORA_SCRUM

            cat > .env << 'ENVFILE'
            # GitHub Configuration
            GITHUB_REPOSITORY=marga-ghale/ora_scrum_backend
            GITHUB_FRONTEND_REPO=marga-ghale/ora_scrum_frontend

            # Database Configuration
            DB_USER=postgres
            DB_PASSWORD=postgres
            DB_NAME=ora_scrum
            DB_PORT=5432

            # JWT Configuration
            JWT_EXPIRY=24
            REFRESH_EXPIRY=168

            # Application
            ENVIRONMENT=production
            API_PORT=8080
            FRONTEND_URL=https://scrum.oratechnologies.io
            ENVFILE

            # Append secrets separately to handle special characters
            echo "JWT_SECRET=${JWT_SECRET}" >> .env
            echo "SMTP_HOST=${SMTP_HOST}" >> .env
            echo "SMTP_PORT=${SMTP_PORT}" >> .env
            echo "SMTP_USER=${SMTP_USER}" >> .env
            echo "SMTP_PASSWORD=${SMTP_PASSWORD}" >> .env
            echo "SMTP_FROM=${SMTP_FROM}" >> .env
            echo "SMTP_FROM_NAME=ORA Scrum" >> .env
            echo "SMTP_USE_TLS=true" >> .env

            echo "✅ .env file created successfully"
            cat .env | grep -v PASSWORD

      - name: Copy migration files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          source: "internal/db/migrations/*"
          target: "/root/ORA_SCRUM/"
          strip_components: 0
          overwrite: true

      - name: Ensure database is ready
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            cd /root/ORA_SCRUM

            # Start only db and redis first
            docker compose up -d db redis

            # Wait for PostgreSQL to be healthy
            echo "Waiting for PostgreSQL..."
            for i in {1..30}; do
              if docker compose exec -T db pg_isready -U postgres -d ora_scrum > /dev/null 2>&1; then
                echo "✅ PostgreSQL is ready"
                break
              fi
              echo "Attempt $i/30..."
              sleep 2
            done

            # Verify Redis
            echo "Checking Redis..."
            docker compose exec -T redis redis-cli ping || echo "Redis not responding"

      - name: Deploy application
        uses: appleboy/ssh-action@v1.0.3
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_ACTOR: ${{ github.actor }}
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          envs: GH_TOKEN,GH_ACTOR
          script: |
            cd /root/ORA_SCRUM

            # Login to GitHub Container Registry
            echo "${GH_TOKEN}" | docker login ghcr.io -u "${GH_ACTOR}" --password-stdin

            # Pull latest image
            docker pull ghcr.io/marga-ghale/ora_scrum_backend:latest

            # Stop and remove old container
            docker compose stop api || true
            docker compose rm -f api || true

            # Start new container
            docker compose up -d api

            # Wait for container to start
            sleep 10

            # Check container status
            echo "=== Container Status ==="
            docker compose ps api

            # Check logs for errors
            echo "=== Recent Logs ==="
            docker logs ora_scrum_api --tail 100 2>&1

            # Verify health endpoint from inside container network
            echo "=== Health Check ==="
            docker compose exec -T api wget -q -O- http://localhost:8080/health || echo "Health check failed"

            # Cleanup
            docker image prune -f

      - name: Verify deployment
        run: |
          sleep 20
          for i in {1..10}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" https://scrum-api.oratechnologies.io/health 2>/dev/null || echo "000")
            if [ "$response" = "200" ]; then
              echo "✅ Deployment successful!"
              exit 0
            fi
            echo "Attempt $i/10: Status $response, retrying..."
            sleep 5
          done
          echo "❌ Deployment verification failed - check server logs"
          exit 1
